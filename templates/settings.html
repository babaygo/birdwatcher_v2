{% extends "base.html" %}

{% block content %}
<h1 class="text-2xl font-bold mb-6 text-white">Réglages</h1>

<div class="flex flex-col gap-4">

    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-4 shadow-lg">
        <h2 class="text-base font-bold text-blue-400 uppercase tracking-wider mb-3">Système</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p class="text-gray-500 text-base font-semibold">Température CPU</p>
                <p class="text-lg font-medium"><span id="cpu-temp">{{ temp }}</span>°C</p>
            </div>
            <div>
                <p class="text-gray-500 text-base font-semibold">Batterie</p>
                <p class="text-lg font-medium"><span id="bat-percent">{{ battery.percent }}</span>%
                    (<span id="bat-voltage">{{ battery.voltage }}</span>V
                    <span id="bat-current">{{ battery.current }}</span>A
                    <span id="bat-power">{{ battery.power }}</span>W)
                </p>
            </div>
            <div class="col-span-2">
                <div class="flex justify-between items-end mb-1">
                    <p class="text-gray-500 text-base font-semibold">Stockage</p>
                    <p class="text-gray-400 text-base">
                        <span id="disk-used">{{ disk.used_gb }}</span>Go /
                        <span id="disk-total">{{ disk.total_gb }}</span>Go
                    </p>
                </div>

                <div class="w-full bg-gray-700 rounded-full h-1.5 overflow-hidden">
                    <div class="h-1.5 rounded-full transition-all duration-700 {% if disk.percent > 90 %}bg-red-500{% elif disk.percent > 70 %}bg-orange-500{% else %}bg-blue-500{% endif %}"
                        style="width: {{ disk.percent }}%">
                    </div>
                </div>

                <p class="text-base text-gray-600 mt-1 italic text-right">
                    <span id="disk-percent">{{ disk.percent }}</span>% utilisé
                </p>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-4 shadow-lg">
        <h2 class="text-base font-bold text-purple-400 uppercase tracking-wider mb-3">Vidéos</h2>
        <div class="space-y-4">
            <div class="flex flex-col space-y-3">
                <label class="text-gray-500 text-base font-semibold">Paramètres enregistrement vidéo</label>
                <div class="w-full flex items-center space-x-2">
                    <span class="text-sm">Durée d'enregistrement d'une vidéo (max: 120):</span>
                    <input type="number" id="time-clip" value="{{ config.time_clip }}" min="1" max="120"
                        class="w-16 bg-gray-900 border border-gray-600 text-purple-400 text-center font-semibold py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    <span class="text-sm">Secondes</span>
                </div>
                <div class="w-full flex items-center space-x-2">
                    <span class="text-sm">Résolution vidéo :</span>
                    <select id="res-video"
                        class="bg-gray-900 border border-gray-600 text-purple-400 text-sm font-semibold py-2 px-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-colors cursor-pointer">

                        <option value="1920x1080" {% if config.res_video==[1920, 1080] %}selected{% endif %}>1080p (Full
                            HD)</option>

                        <option value="1280x720" {% if config.res_video==[1280, 720] or not config.res_video
                            %}selected{% endif %}>720p (HD)</option>

                        <option value="640x480" {% if config.res_video==[640, 480] %}selected{% endif %}>480p (SD)
                        </option>

                    </select>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex flex-col space-y-3">
                    <span class="text-gray-500 text-base font-semibold">Nettoyage automatique</span>
                    <div class="w-full flex items-center space-x-2">
                        <span class="text-sm">Supprimer les vidéos après</span>
                        <input type="number" id="cleanup-days" value="{{ config.cleanup_days }}" min="1" max="99"
                            class="w-16 bg-gray-900 border border-gray-600 text-purple-400 text-center font-semibold py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        <span class="text-sm">Jours</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-4 shadow-lg">
        <p class="text-xs text-gray-500 mb-4">Éteignez proprement la Raspberry avant de retirer la batterie Li-Po pour
            protéger vos fichiers.</p>
        <a href="/shutdown" onclick="return confirm('Confirmer l\'extinction ?')"
            class="block w-full bg-red-900 bg-opacity-30 border border-red-800 text-red-400 text-center py-3 rounded-xl font-semibold active:bg-red-800 active:text-white transition-all">
            Éteindre la Raspberry
        </a>
    </div>

</div>

<script>
    let statsInterval = null;

    function updateStats() {
        fetch('/api/system_stats')
            .then(response => response.json())
            .then(data => {
                // Mise à jour Batterie
                document.getElementById('bat-percent').innerText = data.battery.percent;
                document.getElementById('bat-voltage').innerText = data.battery.voltage;
                document.getElementById('bat-current').innerText = data.battery.current;
                document.getElementById('bat-power').innerText = data.battery.power;

                // Mise à jour Température
                document.getElementById('cpu-temp').innerText = data.temp;

                // Mise à jour Disque
                document.getElementById('disk-percent').innerText = data.disk.percent;
                document.getElementById('disk-used').innerText = data.disk.used_gb;
                document.getElementById('disk-total').innerText = data.disk.total_gb;

            }).catch(error => console.error('Erreur stats:', error));
    }

    function startUpdating() {
        if (!statsInterval) {
            updateStats();
            statsInterval = setInterval(updateStats, 6000);
            console.log("Flux de données : ACTIF");
        }
    }

    function stopUpdating() {
        if (statsInterval) {
            clearInterval(statsInterval);
            statsInterval = null;
            console.log("Flux de données : VEILLE");
        }
    }

    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            stopUpdating();
        } else {
            startUpdating();
        }
    });

    startUpdating();
</script>

<script>
    const cleanupInput = document.getElementById('cleanup-days');
    const timeclipInput = document.getElementById('time-clip');
    const resvideoInput = document.getElementById('res-video');

    cleanupInput.addEventListener('change', function () {
        let val = parseInt(this.value);

        if (isNaN(val) || val < 1) val = 1;
        if (val > 99) val = 99;
        this.value = val;

        fetch('/api/config/cleanup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cleanup_days: val })
        })
            .then(res => res.json())
            .then(data => {
                console.log("Configuration mise à jour :", data.cleanup_days);
            })
            .catch(err => console.error("Erreur de sauvegarde :", err));
    });

    timeclipInput.addEventListener('change', function () {
        let val = parseInt(this.value);

        if (isNaN(val) || val < 1) val = 1;
        if (val > 120) val = 120;
        this.value = val;

        fetch('/api/config/timeclip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ time_clip: val })
        })
            .then(res => res.json())
            .then(data => {
                console.log("Configuration mise à jour :", data.time_clip);
            })
            .catch(err => console.error("Erreur de sauvegarde :", err));
    });

    resvideoInput.addEventListener('change', function () {
        let val = this.value;
        let resArray = val.split('x').map(Number);

        fetch('/api/config/resvideo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ res_video: resArray })
        })
            .then(res => {
                if (!res.ok) throw new Error("Erreur serveur");
                return res.json();
            })
            .then(data => {
                console.log("Résolution mise à jour avec succès :", data.res_video);
            })
            .catch(err => {
                console.error("Erreur de sauvegarde :", err);
            });
    });
</script>
{% endblock %}